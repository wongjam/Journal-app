{% extends "base.html" %}
{% block title %}{{ t("LLM è¯„è®ºè®¾ç½®") }} Â· {{ t("æˆ‘çš„å¿ƒå¾—") }}{% endblock %}

{% block content %}
<div class="row g-3">
  <div class="col-12 col-lg-7">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">{{ t("Ollama / LLM é…ç½®") }}</h5>
          <div class="ms-auto d-flex align-items-center gap-2">
            <div class="form-check form-switch mb-0">
              <input class="form-check-input" type="checkbox" id="autoEnabledSwitch" {% if cfg.auto_enabled %}checked{% endif %}>
              <label class="form-check-label" for="autoEnabledSwitch">{{ t("è‡ªåŠ¨è¯„è®º") }}</label>
            </div>
            <span id="autoEnabledBadge" class="badge {% if cfg.auto_enabled %}text-bg-success{% else %}text-bg-secondary{% endif %}">{% if cfg.auto_enabled %}{{ t("å¼€å¯") }}{% else %}{{ t("å…³é—­") }}{% endif %}</span>
          </div>
          <form method="post" action="{{ url_for('llm_test_connection') }}">
            <button class="btn btn-sm btn-outline-secondary" type="submit">{{ t("æµ‹è¯•è¿æ¥") }}</button>
          </form>
        </div>
        <div class="alert alert-light border mt-3 mb-0">
          {{ t("å½“å‰è‡ªåŠ¨è¯„è®ºçŠ¶æ€ï¼š") }} <span id="autoEnabledBadge2" class="badge {% if cfg.auto_enabled %}text-bg-success{% else %}text-bg-secondary{% endif %}">{% if cfg.auto_enabled %}{{ t("å¼€å¯") }}{% else %}{{ t("å…³é—­") }}{% endif %}</span>
          <div class="text-muted small mt-1">{{ t("å…³é—­æ—¶ï¼Œåå°ä¸ä¼šå®šæ—¶ç”Ÿæˆï¼›ä½†â€œç«‹å³è¯„è®ºâ€ä»ç„¶å¯ç”¨ã€‚") }}</div>
        </div>

        <script>
          (function(){
            const sw = document.getElementById('autoEnabledSwitch');
            const b1 = document.getElementById('autoEnabledBadge');
            const b2 = document.getElementById('autoEnabledBadge2');

            function setBadge(on){
              const text = on ? '{{ t("å¼€å¯") }}' : '{{ t("å…³é—­") }}';
              [b1,b2].forEach(b => {
                if (!b) return;
                b.textContent = text;
                b.classList.remove('text-bg-success','text-bg-secondary');
                b.classList.add(on ? 'text-bg-success' : 'text-bg-secondary');
              });
            }

            if (sw){
              sw.addEventListener('change', async function(){
                const enabled = !!sw.checked;
                // optimistic UI update
                setBadge(enabled);
                try {
                  const resp = await fetch('{{ url_for('api_llm_set_auto_enabled') }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                  });
                  const data = await resp.json();
                  if (!data || !data.ok){ throw new Error('bad response'); }
                  setBadge(!!data.auto_enabled);
                  sw.checked = !!data.auto_enabled;
                } catch (e){
                  // revert if failed
                  sw.checked = !enabled;
                  setBadge(!enabled);
                  alert('{{ t('åˆ‡æ¢å¤±è´¥ï¼šè¯·æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚') }}');
                }
              });
            }
          })();
        </script>

        {% if error %}
          <div class="alert alert-warning mt-3 mb-0">{{ error }}</div>
        {% endif %}

        <form class="mt-3" method="post" action="{{ url_for('llm_save') }}">
          <div class="row g-2 mt-2">
            <div class="col-8">
              <label class="form-label">{{ t("æœåŠ¡å™¨") }}</label>
              <input class="form-control" name="server" value="{{ cfg.server }}" placeholder="127.0.0.1">
            </div>
            <div class="col-4">
              <label class="form-label">{{ t("ç«¯å£") }}</label>
              <input class="form-control" name="port" value="{{ cfg.port }}" placeholder="11434">
            </div>
          </div>

          <div class="mt-3">
            <label class="form-label">{{ t("æ¨¡å‹é™åˆ¶ï¼ˆå¯å¤šé€‰ï¼›ä¸é€‰=å…è®¸å…¨éƒ¨ï¼‰") }}</label>
            <select class="form-select" name="allowed_models" multiple size="6">
              {% for m in models %}
                <option value="{{ m }}" {% if m in cfg.allowed_models %}selected{% endif %}>{{ m }}</option>
              {% endfor %}
            </select>
            <div class="form-text">{{ t("å¦‚æœè¿™é‡Œç©ºç™½ï¼Œè¯´æ˜å½“å‰æœªèƒ½æ‹‰å–æ¨¡å‹åˆ—è¡¨ï¼ˆå¯å…ˆç‚¹â€œæµ‹è¯•è¿æ¥â€ï¼‰ã€‚") }}</div>
          </div>

          <div class="row g-2 mt-3">
            <div class="col-md-6">
              <label class="form-label">{{ t("é»˜è®¤é¢‘ç‡ï¼ˆåˆ†é’Ÿï¼‰") }}</label>
              <input class="form-control" name="default_interval_minutes" value="{{ cfg.default_interval_minutes }}">
              <div class="form-text">{{ t("é»˜è®¤æ¯ 120 åˆ†é’Ÿï¼ˆ=2å°æ—¶ï¼‰") }}</div>
            </div>
            <div class="col-md-6">
              <label class="form-label">{{ t("æ¯ç¯‡é»˜è®¤æœ€å¤šè¯„è®ºæ¬¡æ•°") }}</label>
              <input class="form-control" name="max_comments_per_post_default" value="{{ cfg.max_comments_per_post_default }}">
            </div>
          </div>

          <div class="mt-3">
            <label class="form-label">{{ t("æŒ‘é€‰æ–‡ç« ç­–ç•¥") }}</label>
            <select class="form-select" name="random_pick_mode">
              <option value="random_uncommented_first" {% if cfg.random_pick_mode == "random_uncommented_first" %}selected{% endif %}>{{ t("ä¼˜å…ˆæ²¡è¢«è¯„è®ºè¿‡çš„æ–‡ç« ï¼Œå…¶æ¬¡éšæœº") }}</option>
              <option value="latest" {% if cfg.random_pick_mode == "latest" %}selected{% endif %}>{{ t("ä¼˜å…ˆæœ€æ–°æ–‡ç« ") }}</option>
            </select>
          </div>

          <hr class="my-4">

          <h6 class="mb-2">{{ t("æ¨¡å‹ç»†åŒ–è®¾ç½®ï¼ˆå¯é€‰ï¼‰") }}</h6>
          <div class="text-muted small mb-2">{{ t("ä½ å¯ä»¥é’ˆå¯¹æ¯ä¸ªæ¨¡å‹è®¾ç½®ï¼šé—´éš”åˆ†é’Ÿæ•° / æ¯ç¯‡æœ€å¤šè¯„è®ºæ¬¡æ•°ã€‚") }}</div>

          <div class="vstack gap-2">
            {% for m in models %}
              <div class="p-2 border rounded-3">
                <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
                  <div class="fw-semibold">{{ m }}</div>
                  <div class="d-flex gap-2">
                    <div>
                      <div class="text-muted small">{{ t("é—´éš”(åˆ†é’Ÿ)") }}</div>
                      <input class="form-control form-control-sm" style="width: 120px;"
                        name="interval__{{ m }}" value="{{ cfg.interval_minutes_by_model.get(m, '') }}" placeholder="{{ t('ä¾‹å¦‚ 120') }}">
                    </div>
                    <div>
                      <div class="text-muted small">{{ t("æ¯ç¯‡ä¸Šé™") }}</div>
                      <input class="form-control form-control-sm" style="width: 120px;"
                        name="max__{{ m }}" value="{{ cfg.max_comments_per_post_by_model.get(m, '') }}" placeholder="{{ t('ä¾‹å¦‚ 2') }}">
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>

          <hr class="my-4">

          <h6 class="mb-2">{{ t("æç¤ºè¯ç®¡ç†") }}</h6>
          <div class="text-muted small mb-2">{{ t("ä¸ºäº†ç®€å•å¥½ç»´æŠ¤ï¼Œè¿™é‡Œç”¨â€œJSON æ•°ç»„â€ç¼–è¾‘æç¤ºè¯é¢„è®¾ï¼ˆæ¯ä¸ªé¢„è®¾åŒ…å« id/name/system/user_prefixï¼‰ã€‚") }}</div>

          <div class="mb-2">
            <label class="form-label">{{ t("å½“å‰å¯ç”¨çš„é¢„è®¾ IDï¼ˆå¯å¤šä¸ªï¼Œç”¨è‹±æ–‡é€—å·åˆ†éš”ï¼›å°†éšæœºé€‰æ‹©ï¼‰") }}</label>
            <input class="form-control" name="active_prompt_preset_id" value="{{ cfg.active_prompt_preset_id }}">
          </div>

          <div class="mb-3">
            <label class="form-label">{{ t("æç¤ºè¯é¢„è®¾ï¼ˆJSON æ•°ç»„ï¼‰") }}</label>
            <textarea class="form-control font-mono" name="prompt_presets_json" rows="10"
              placeholder='[{"id":"x","name":"y","system":"...","user_prefix":"..."}]'>{{ prompt_presets_text }}</textarea>
          </div>

          <div class="d-grid">
            <button class="btn btn-primary" type="submit">{{ t("ä¿å­˜é…ç½®") }}</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-5">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">{{ t("ç«‹å³è¯„è®º") }}</h5>
        <div class="text-muted small">{{ t("ç«‹åˆ»æŒ‘ä¸€ç¯‡å¯è¯„è®ºçš„ç¬”è®°ï¼Œç”Ÿæˆ 1 æ¡è¯„è®ºï¼ˆä¸ä¼šè¶…è¿‡â€œæ¯ç¯‡ä¸Šé™â€ï¼‰ã€‚") }}</div>

        <form class="mt-3 js-llm-run" method="post" action="{{ url_for('llm_run_now_fallback') }}" data-endpoint="{{ url_for('api_llm_run_now') }}">
          <label class="form-label">{{ t("é€‰æ‹©æ¨¡å‹") }}</label>
          <select class="form-select" name="model" required>
            <option value="" selected disabled>{{ t("è¯·é€‰æ‹©") }}</option>
            <option value="random">{{ t("ğŸ² éšæœºæ¨¡å‹") }}</option>
            {% for m in models %}
              <option value="{{ m }}">{{ m }}</option>
            {% endfor %}
          </select>
          <div class="d-grid mt-3">
            <button class="btn btn-success" type="button" data-action="run">{{ t("ç«‹å³è¯„è®ºï¼ˆç”Ÿæˆä¸€æ¡ï¼‰") }}</button>
          </div>
        </form>

        <hr class="my-4">

        <div class="alert alert-info mb-0">
          <div class="fw-semibold mb-1">{{ t("ä¿å­˜ä½ç½®") }}</div>
          <ul class="mb-0">
            <li>{{ t("LLM è®¾ç½®ï¼š") }}<code>data/llm_config.json</code></li>
            <li>{{ t("è¯„è®ºå†…å®¹ï¼š") }}<code>data/comments.json</code></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
